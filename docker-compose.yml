version: '3.9'

services:
  vtx:
    image: ghcr.io/0-5788719150923125/src:1
    command: nodemon --ignore "models/*" --ignore "*.json" --exec python3 main.py
    restart: 'always'
    user: 1000:1000
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
    ulimits:
      memlock: -1
    build:
      context: .
      dockerfile: Dockerfile
      shm_size: '1gb'
    stdin_open: true
    tty: true
    volumes:
      - ./lab:/lab
      - ./vtx:/vtx
    env_file:
      - .env
    environment:
      FOCUS: head
      TRANSFORMERS_CACHE: /tmp

  ctx:
    image: ghcr.io/0-5788719150923125/src:1
    command: node root.js
    ports:
      - 9666:9665

  ips:
    image: ipfs/kubo:master-latest
    command: daemon --migrate=true --agent-version-suffix=docker --init-profile=lowpower --writable --enable-gc --enable-pubsub-experiment --enable-namesys-pubsub

  dsh:
    image: tensorflow/tensorflow:2.11.0
    command: 'tensorboard --logdir logs --bind_all'
    volumes:
      - ./lab/logs:/logs
    ports:
      - 6006:6006
